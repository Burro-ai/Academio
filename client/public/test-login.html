<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Academio Login Test</title>
  <style>
    body { font-family: system-ui, -apple-system, sans-serif; max-width: 600px; margin: 40px auto; padding: 20px; }
    .card { background: #f5f5f5; border-radius: 12px; padding: 20px; margin: 20px 0; }
    .success { background: #d4edda; border: 1px solid #c3e6cb; }
    .error { background: #f8d7da; border: 1px solid #f5c6cb; }
    .info { background: #d1ecf1; border: 1px solid #bee5eb; }
    button { background: #10b981; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; margin: 5px; }
    button:hover { background: #059669; }
    button.danger { background: #ef4444; }
    button.danger:hover { background: #dc2626; }
    input { padding: 10px; border: 1px solid #ccc; border-radius: 6px; width: 100%; margin: 5px 0; box-sizing: border-box; }
    pre { background: #1f2937; color: #10b981; padding: 15px; border-radius: 8px; overflow-x: auto; font-size: 12px; }
    h1 { color: #1f2937; }
    h3 { margin-top: 0; }
    #log { max-height: 300px; overflow-y: auto; }
  </style>
</head>
<body>
  <h1>ðŸŽ“ Academio Login Test</h1>

  <div class="card">
    <h3>Step 1: Clear Old Data</h3>
    <p>First, clear any corrupted localStorage data:</p>
    <button class="danger" onclick="clearStorage()">Clear All Auth Data</button>
    <div id="clearResult"></div>
  </div>

  <div class="card">
    <h3>Step 2: Test Login API</h3>
    <input type="email" id="email" placeholder="Email" value="emma.rodriguez@student.academio.edu">
    <input type="password" id="password" placeholder="Password" value="password123">
    <button onclick="testLogin()">Test Login</button>
    <button onclick="testTeacherLogin()">Test Teacher Login</button>
    <div id="loginResult"></div>
  </div>

  <div class="card">
    <h3>Step 3: Check Current State</h3>
    <button onclick="checkState()">Check localStorage State</button>
    <div id="stateResult"></div>
  </div>

  <div class="card info">
    <h3>Test Credentials</h3>
    <p><strong>Student:</strong> emma.rodriguez@student.academio.edu / password123</p>
    <p><strong>Teacher:</strong> sarah.johnson@academio.edu / password123</p>
  </div>

  <div class="card">
    <h3>Log</h3>
    <pre id="log"></pre>
  </div>

  <script>
    function log(msg) {
      const logEl = document.getElementById('log');
      const time = new Date().toLocaleTimeString();
      logEl.textContent = `[${time}] ${msg}\n` + logEl.textContent;
      console.log(msg);
    }

    function clearStorage() {
      localStorage.removeItem('academio_token');
      localStorage.removeItem('academio_user');
      localStorage.removeItem('academio_profile');
      sessionStorage.removeItem('teacherPassword');

      document.getElementById('clearResult').innerHTML =
        '<div class="card success"><strong>âœ“ Cleared!</strong> All auth data removed from localStorage and sessionStorage.</div>';
      log('Cleared all auth data');
      checkState();
    }

    async function testLogin() {
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      const resultDiv = document.getElementById('loginResult');

      log(`Testing login for: ${email}`);
      resultDiv.innerHTML = '<div class="card info">Testing...</div>';

      try {
        const response = await fetch('/api/auth/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        });

        const data = await response.json();

        if (response.ok) {
          resultDiv.innerHTML = `
            <div class="card success">
              <strong>âœ“ Login Successful!</strong><br>
              User: ${data.user.name} (${data.user.role})<br>
              Token: ${data.token.substring(0, 50)}...<br>
              Redirect: ${data.redirectTo}
            </div>
          `;
          log(`Login successful: ${data.user.name} (${data.user.role})`);

          // Store in localStorage like the app would
          localStorage.setItem('academio_token', data.token);
          localStorage.setItem('academio_user', JSON.stringify(data.user));
          log('Stored token and user in localStorage');
        } else {
          resultDiv.innerHTML = `<div class="card error"><strong>âœ— Login Failed:</strong> ${data.message || data.error}</div>`;
          log(`Login failed: ${data.message || data.error}`);
        }
      } catch (err) {
        resultDiv.innerHTML = `<div class="card error"><strong>âœ— Error:</strong> ${err.message}</div>`;
        log(`Login error: ${err.message}`);
      }
    }

    function testTeacherLogin() {
      document.getElementById('email').value = 'sarah.johnson@academio.edu';
      document.getElementById('password').value = 'password123';
      testLogin();
    }

    function checkState() {
      const token = localStorage.getItem('academio_token');
      const user = localStorage.getItem('academio_user');
      const profile = localStorage.getItem('academio_profile');

      let html = '<div class="card">';
      html += `<strong>Token:</strong> ${token ? token.substring(0, 50) + '...' : '(none)'}<br>`;
      html += `<strong>User:</strong> ${user ? JSON.parse(user).email : '(none)'}<br>`;
      html += `<strong>Profile:</strong> ${profile ? 'Present' : '(none)'}<br>`;
      html += '</div>';

      document.getElementById('stateResult').innerHTML = html;
      log(`State check - Token: ${!!token}, User: ${!!user}, Profile: ${!!profile}`);
    }

    // Initial state check
    checkState();
    log('Test page loaded');
  </script>
</body>
</html>
